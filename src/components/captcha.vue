<template>
    <div>
        <div class="input-tip">
            <div class="row-line full-width">
                <div class="iconbox inline-block full-height vertical-align">
                    <svg viewBox="0 0 200 200" class="vertical-align icon-size">
                        <use xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#email"></use>
                    </svg>
                </div>
                <eInput v-model.trim="emailInput" class="transparent inline-block vertical-align inputword"></eInput>
                <sendcode :start='start' @countDown='start=false' @click.native='sendCode' class="inline-block vertical-align code-box"></sendcode>
            </div>
            <div v-if="$v.emailInput.email && $v.emailInput.required && $v.emailInput.isUnique" class="find-check tip-color">您输入的账号不存在，请重新输入
            </div>
            <div v-if="!$v.emailInput.email" class="find-check tip-color">邮箱格式有误</div>
        </div>
        <div class="input-tip">
            <div class="row-line full-width">
                <div class="iconbox inline-block full-height vertical-align">
                    <svg viewBox="0 0 200 200" class="vertical-align icon-size">
                        <use xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#captcha"></use>
                    </svg>
                </div>
                <input type="text" v-model.trim="captchaInput" class="transparent inline-block vertical-align inputword" placeholder="输入验证码">
            </div>
            <div v-if="this.wrong" class="find-check tip-color">验证码错误</div>
        </div>
        <button v-on:click="next" class="btn next vertical-align" :style="{'background-color': this.code && this.captchaInput ? '#ff860d':'#d2d2d2' }">下一步</button>
    </div>
</template>
<script>
import sendcode from './sendcode.vue'
import Input from './Input.vue'
import {
    email,
    required,
    isUnique
} from 'vuelidate/lib/validators'
import Service from "../service"
export default {
    data() {
            return {
                emailInput: '',
                captchaInput: '',
                start: false,
                code: false,
                wrong: false
            }
        },
        components: {
            "eInput": Input,
            "sendcode": sendcode
        },
        validations: {
            emailInput: {
                email,
                required,
                isUnique(value) {
                    return new Promise(
                        (resolve, reject) => {
                        Service.checkEmail(value).then(res => {
                            resolve(res.ok)
                        },() => {
                            reject(res.ok)
                        })
                    })
                }
            }
        },
        created() {
            this.$parent.message = []
        },
        methods: {
            sendCode(value) {
                value.stopPropagation();
                value.preventDefault();
                console.log(this.emailInput)
                if (this.$v.emailInput.email && !this.$v.emailInput.isUnique && this.$v.emailInput.required) {
                    Service.getCaptcha(this.emailInput).then(res => {
                        if (res!== null && res !== undefined) {
                            this.start = true
                            this.code = true
                        }
                    })
                }
            },
            next() {
                if (this.code && this.captchaInput) {
                    Service.checkCaptcha(this.emailInput, this.captchaInput).then(res => {
                        if (res!==null && res !== undefined) {
                            this.$parent.message.push(this.emailInput)
                            this.$parent.message.push(this.captchaInput)
                            this.$router.push('reset')
                        } else {
                            this.wrong = true
                        }
                    })
                }
            }
        }
}
</script>
<style>
</style>
